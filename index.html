<!DOCTYPE html>
<html>
<head>
  <title>Watch Together</title>
</head>
<body>
  <video id="video" width="640" controls>
    <source src="your-movie.mp4" type="video/mp4">
  </video>

  <button id="startCall">Start Voice Call</button>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const video = document.getElementById('video');

    // Sync video events
    video.addEventListener('play', () => {
      socket.emit('video-event', { type: 'play', currentTime: video.currentTime });
    });

    video.addEventListener('pause', () => {
      socket.emit('video-event', { type: 'pause', currentTime: video.currentTime });
    });

    video.addEventListener('seeked', () => {
      socket.emit('video-event', { type: 'seek', currentTime: video.currentTime });
    });

    socket.on('video-event', (data) => {
      if (data.type === 'play') {
        video.currentTime = data.currentTime;
        video.play();
      } else if (data.type === 'pause') {
        video.currentTime = data.currentTime;
        video.pause();
      } else if (data.type === 'seek') {
        video.currentTime = data.currentTime;
      }
    });

    // WebRTC voice call setup (simplified)
    let localStream;
    let peerConnection;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    document.getElementById('startCall').onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      peerConnection = new RTCPeerConnection(configuration);

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      peerConnection.ontrack = (event) => {
        const remoteAudio = document.getElementById('remoteAudio') || (() => {
          const audio = document.createElement('audio');
          audio.id = 'remoteAudio';
          audio.autoplay = true;
          document.body.appendChild(audio);
          return audio;
        })();
        remoteAudio.srcObject = event.streams[0];
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit('webrtc-ice-candidate', event.candidate);
        }
      };

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('webrtc-offer', offer);
    };

    socket.on('webrtc-offer', async (offer) => {
      if (!peerConnection) {
        peerConnection = new RTCPeerConnection(configuration);
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

        peerConnection.ontrack = (event) => {
          const remoteAudio = document.getElementById('remoteAudio') || (() => {
            const audio = document.createElement('audio');
            audio.id = 'remoteAudio';
            audio.autoplay = true;
            document.body.appendChild(audio);
            return audio;
          })();
          remoteAudio.srcObject = event.streams[0];
        };

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit('webrtc-ice-candidate', event.candidate);
          }
        };
      }

      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
      socket.emit('webrtc-answer', answer);
    });

    socket.on('webrtc-answer', async (answer) => {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
    });

    socket.on('webrtc-ice-candidate', async (candidate) => {
      try {
        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (e) {
        console.error('Error adding received ice candidate', e);
      }
    });
  </script>
</body>
</html>
